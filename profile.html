<!DOCTYPE html>
<html>
  <head>
    <title>In Browser Borderlands 3 Profile Editor</title>
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://abramhindle.github.io/bl3-cli-saveedit/" />
    <meta property="og:title" content="In Browser Borderlands 3 Profile Editor" />
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
    <style>
      .disabled {
          pointer-events: none;
          opacity: 0.4;
      }
      #status {
          background-color: yellow;
      }
      p, ul, ol {
          margin: 1em;
          min-width: 10em;
          width: 50vh;
          padding: 0.25em;
      }
      h1, h2, h3 {
          padding: 0.25em ;
      }
      .smaller {
          font-size: x-small;
      }
      input.numberOption {
          width: 9em;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Online In Browser Borderlands 3 Profile Editor</h1>
      <p>
        Do you want to modify Borderlands 3 Profiles, BL3 profile files, 
	or Borderlands 3 Profiles / Bank?
        This is tech demo about running Python code in the browser,
        but you may use it to the modify the profiles in BL3.
      </p>
            <p> Do you want to edit your save file instead? <a href="index.html">Try out the In Browser Borderlands 3 Save Editor</a>.</p>
      <p>
        Using <a href="https://pyodide.org/en/stable/">Pyodide</a> I managed to host the python commandline program <a href="https://github.com/abramhindle/bl3-cli-saveedit/">bl3-cli-saveedit</a> on the web! So this means python is running in your browser. If you want to run it at home just run on a Linux or OSX computer:
        <code>
          <pre>
            pip3 install --user bl3-cli-savedit
          </pre>
        </code>
      <p>
        More documentation for the commandline program is here: <a href="https://github.com/apocalyptech/bl3-cli-saveedit/">bl3-cli-saveedit</a>
      </p>
      </p>
      <h3>bl3-cli-saveedit in your browser</h3>
      <p>
        This webpage provides a user interface for you to modify your Borderlands 3 (BL3) profiles files.
        What can this profile editor do?
      </p>
      <ul>
	<li> Modify Skeleton Keys (bad! don't do that)
        <li> zero your myth rank!
        <li> Max out myth rank (bad!)
        <li> Modify myth rank points
        <li> Modify bank items
        <li> Import bank items
        <li> Remove customizations
        <li> Unlock lost loot and bank SDUs
      </ul>
      <h3>Instructions:</h3>
      <ol>
        <li> First load the example file or "upload" your profile file. This program will not send your profile anywhere, they will be locally manipulated in your browser. The details of the file will be printed below.
        <li> Second, manipulate your profile. Every button will send you a new savefile that you can download.
        <li> Copy your savefile into your BL3 save game directory or folder (BUT KEEP A BACKUP).
      </ol>
      <h3>No support provided:</h3>
      <p class="smaller">
        Here's where I come off as a jerk:
        I will listen to actual coherent
        bug
        reports <a href="https://github.com/abramhindle/bl3-cli-saveedit/issues">here</a>. I am not very interested in feature requests. This is a technology demo.
        I will gladly accept pull requests. If you want something, then make it better, it is opensource, I just wanted to deploy python in the browser. Don't contact me about windows issues, or mac issues, or ask me where savefiles are stored. I don't know these things and I don't have any answers.
      </p>
    </div>
    <div id="status">Loading</div>
    <div id="ui">
      <button id="example" onclick="loadProfileExample()">Load Example</button> or upload your own:
      <input name="upload" id="profileUpload" type="file"><br>
      <div>
      <pre class="needFile">
Borderlands 3 CLI Profile Editor v1.16.1b1 (PC Only)

positional arguments:
  input_filename        Input filename
  output_filename       Output filename

optional arguments:
  -h, --help            show this help message and exit
<span class="flag" id="-V"></span>  -V, --version         show program's version number and exit
  -o {profile,protobuf,json,items}, --output {profile,protobuf,json,items}
                        Output file format (default: profile)
<span class="flag" id="--csv"></span>  --csv                 When importing or exporting items, use CSV files (default: False)
  -f, --force           Force output file to overwrite (default: False)
  -q, --quiet           Supress all non-essential output (default: False)
<span class="numberOption" id="--golden-keys"></span> --golden-keys GOLDEN_KEYS
                        Number of Golden Keys in the profile (default: None)
<span class="numberOption" id="--diamond-keys"></span>  --diamond-keys DIAMOND_KEYS
                        Number of Diamond Keys in the profile (default: None)
<span class="numberOption" id="--vaultcard1-keys"></span>  --vaultcard1-keys VAULTCARD1_KEYS
                        Number of Vault Card 1 Keys in the profile (default: None)
<span class="numberOption" id="--vaultcard1-chests"></span>  --vaultcard1-chests VAULTCARD1_CHESTS
                        Number of Vault Card 1 Chests available in the profile (default: None)
<span class="numberOption" id="--vaultcard2-keys"></span>  --vaultcard2-keys VAULTCARD2_KEYS
                        Number of Vault Card 2 Keys in the profile (default: None)
<span class="numberOption" id="--vaultcard2-chests"></span>  --vaultcard2-chests VAULTCARD2_CHESTS
                        Number of Vault Card 2 Chests available in the profile (default: None)
<span class="numberOption" id="--vaultcard3-keys"></span>  --vaultcard3-keys VAULTCARD3_KEYS
                        Number of Vault Card 3 Keys in the profile (default: None)
<span class="numberOption" id="--vaultcard3-chests"></span>  --vaultcard3-chests VAULTCARD3_CHESTS
                        Number of Vault Card 3 Chests available in the profile (default: None)
<span class="flag" id="--zero-guardian-rank"></span> --zero-guardian-rank  Zero out profile Guardian Rank (default: False)
<span class="flag" id="--min-guardian-rank"></span>  --min-guardian-rank   Set Guardian Rank to minimum required to prevent overwriting by saves (default: False)
<span class="numberOption" id="--guardian-rank-rewards"></span>  --guardian-rank-rewards GUARDIAN_RANK_REWARDS
                        Set Guardian Rank rewards to the specified number of tokens each (default: None)
<span class="numberOption" id="--guardian-rank-tokens"></span>  --guardian-rank-tokens GUARDIAN_RANK_TOKENS
                        Number of available Guardian Rank tokens (default: None)
<span class="flag" id="--reset-borderlands-science"></span>  --reset-borderlands-science
                        Reset Borderlands Science progression (default: False)
<span class="flag" id="--max-borderlands-science"></span>  --max-borderlands-science
                        Maximize Borderlands Science progression, unlocking True Tannis (default: False)
<span class="flag" id="--remove-borderlands-science-boosts"></span>  --remove-borderlands-science-boosts
                        Remove the currently active borderlands science boost (default: False)
<span class="numberOption" id="--borderlands-science-tokens"></span>  --borderlands-science-tokens BORDERLANDS_SCIENCE_TOKENS
                        Number of available Borderlands Science tokens (default: None)
<span class="flag" id="--item-levels-max"></span>  --item-levels-max     Set all bank items to max level (default: False)
<span class="numberOption" id="--item-levels"></span>  --item-levels ITEM_LEVELS
                        Set all bank items to the specified level (default: None)
<span class="flag" id="--item-mayhem-max"></span>  --item-mayhem-max     Set all bank items to the maximum Mayhem level (10) (default: False)
<span class="numberOption" id="--item-mayhem-levels"></span>  --item-mayhem-levels {0,1,2,3,4,5,6,7,8,9,10}
                        Set all bank items to the specified Mayhem level (0 to remove) (default: None)
<span class="textFile" id="-i" filename="/import.txt"></span>  -i IMPORT_ITEMS, --import-items IMPORT_ITEMS
                        Import items from file (default: None)
<span class="flag" id="--allow-fabricator"></span> --allow-fabricator    Allow importing Fabricator when importing items from file (default: False)
<span class="flag" id="--clear-customizations"></span>  --clear-customizations
                        Remove all unlocked customizations (default: False)
<span class="flag" id="--alpha"></span>  --alpha               Alphabetize unlocked room decorations, trinkets, and weapon skins (default: False)
<span class="textOption" id="--unlock"></span>  --unlock {lostloot,bank,skins,heads,echothemes,emotes,decos,weaponskins,trinkets,customizations,all}
                        Game features to unlock (default: {})

The default output type of "profile" will output theoretically-valid profile which can be loaded into BL3. The output type "protobuf" will save
out the extracted, decrypted protobufs. The output type "json" will output a JSON-encoded version of the protobufs in question. The output type
"items" will output a text file containing base64-encoded representations of items in the user's bank. These can be read back in using the
-i/--import-items option. Note that these are NOT the same as the item strings used by the BL3 Memory Editor.

      </pre>
      <button class="needFile" id="run" onclick="runBL3ProfileEdit()">Run bl3-profile-edit and download modified profile file</button>
    </div>
    <div>
          <code>
            <pre id="output">
            </pre>
          </code>
      <h2> Profile Info <h2>
          <code>
            <pre id="pinfo">
            </pre>
          </code>
    </div>
    <script type="text/javascript">
      var pkg = undefined;
      var content = undefined;
      var targetExe = "bl3-profile-edit";
      var targetFile = "/profile.sav";
      function disableUI(v) {
          v = v?true:false;
          [...(document.getElementById("ui").children)].forEach( elm => {
              if (v) {
                  elm.classList.add("disabled");
              } else {
                  elm.classList.remove("disabled");
              }
          });
      }
      function disableNeedFile(v) {
          v = v?true:false;
          [...(document.getElementsByClassName("needFile"))].forEach( elm => {
              if (v) {
                  elm.classList.add("disabled");
              } else {
                  elm.classList.remove("disabled");
              }
          });
      }
      function status(x) {
          document.getElementById("status").innerText = x;
      }
      function installListeners() {
	  var upload = document.getElementById("profileUpload");
	  if (upload) {
              upload.onchange = function(e) {
                  const file = e.target.files[0];
                  console.log(file);
                  loadFile(file);
              };
          }
	  var profileUpload = document.getElementById("profileUpload");
	  if (profileUpload) {
              profileUpload.onchange = function(e) {
                  const file = e.target.files[0];
                  console.log(file);
                  loadProfileFile(file);
              };
          }
      }
      function characterInfo() {
          document.getElementById("cinfo").innerText = pkg.character_info();
      }
      function profileInfo() {
          document.getElementById("pinfo").innerText = pkg.profile_info();
      }
      function logOutput(text) {
          document.getElementById("output").innerText = text;
      }
      function loadExample() {
          if (pkg === undefined) {
              status("File not loaded yet");
              return;
          }
          status("Loading Example!");
          pkg.load_example().then( res => {
              status("BL3Save loaded: " + res);
              characterInfo();
              disableNeedFile(false);
          });
      }
      function loadProfileExample() {
          if (pkg === undefined) {
              status("File not loaded yet");
              return;
          }
          status("Loading Example!");
          pkg.load_profile_example().then( res => {
              status("BL3 Profile loaded: " + res);
              profileInfo();
              disableNeedFile(false);
          });
      }
      function loadFile(file) {
          // josephernest https://github.com/pyodide/pyodide/issues/679#issuecomment-637519913
          var reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = evt => { 
              content = evt.target.result; 
              status("Bytes written: "+pkg.load_file_from_browser());
              profileInfo();
              disableNeedFile(false);
          }          
      }
      function loadProfileFile(file) {
          // josephernest https://github.com/pyodide/pyodide/issues/679#issuecomment-637519913
          var reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = evt => { 
              content = evt.target.result; 
              status("Bytes written: "+pkg.load_file_from_browser("/profile.sav"));
              profileInfo();
              disableNeedFile(false);
          }          
      }
      function downloadInputFile(filename) {
          var array = pkg.get_input_file();
          downloadArray(array,filename);
      }
      function downloadProfileFile(filename) {
          var array = pkg.get_profile_file();
          downloadArray(array,filename);
      }
      function downloadOutputFile() {
          var array = pkg.get_output_file();
          var filename = "bl3-"+pkg.get_guid()+".sav";
          downloadArray(array,filename);
      }
      function downloadArray(array,filename) {
          var blob = new Blob([array], {type: 'application/octet-stream'});
          var url = window.URL.createObjectURL(blob);
          // This part is dumb, why javascript do I have to do this?
          var anchor = window.document.createElement('a');
          anchor.href = url;
          anchor.download = filename?filename:"output.sav";
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);          
      }
      function randomizeGUID() {
          disableUI(true);          
          status("Randomizing the GUID");
          var newGUID = pkg.randomize_guid();
          status("New GUID: "+newGUID);
          characterInfo();
          // downloadOutputFile();
          downloadInputFile("bl3-"+newGUID+".sav");
          disableUI(false);
      }

      function isOptionEnabled( domObj ) {
          var elm = domObj.querySelector('.optionEnable');
          return elm.checked;
      }
      function getValueOfOption( domObj ) {
          if (domObj.classList.contains('textFile')) {
              return domObj.getAttribute('filename');
          }
          var v = domObj.querySelector('input.numberOption, input.textOption');
          return v.value;
      }
      function getTextFileInput( domObj ) {
          if (domObj.classList.contains('textFile') && isOptionEnabled(domObj)) {
              var v = domObj.querySelector('textarea.textFile');
              return v.value;
          }
          return "";
      }
      function commandLineArgs() {
          var flags = [...document.querySelectorAll('span.flag')];
          var checked = flags.filter( isOptionEnabled );
          var checkedOptions = checked.map( x => [x.id] ).flat();
          // console.log(["CheckOptions",checkedOptions]);
          var values = [...document.querySelectorAll('span.numberOption, span.textOption, span.textFile')];
          // console.log(["Values",values]);
          var valued = values.filter( isOptionEnabled );
          // console.log(["Valued",valued]);
          var valuedOptions = valued.map( x => [x.id, getValueOfOption(x) ] ).flat();
          // console.log(valuedOptions);
          return checkedOptions.concat( valuedOptions );
      }
      function computeCommandline() {
          var args = commandLineArgs();
          var text = args.join(" ");          
          console.log(text);
          status( targetExe + " -f " + text + " " + targetFile + " " + targetFile );
      }
      function makeCheckBox(option) {
          var input = document.createElement("input");
          input.type = "checkbox";
          input.setAttribute('class', "optionEnable");
          input.setAttribute('option', option);
          input.onchange = computeCommandline;
          return input;
      }
      function makeTextInput(option) {
          var input = document.createElement("input");
          input.type = "text";
          input.setAttribute('class', "textOption");
          input.setAttribute('option', option);
          input.onchange = computeCommandline;
          return input;
      }
      function makeNumberInput(option) {
          var input = makeTextInput(option);
          input.setAttribute('class',"numberOption");
          // input.setAttribute('size',9);
          return input;
      }
      function makeTextFileInput(option,filename) {
          var input = document.createElement("textarea");
          input.setAttribute('class', "textFile");
          input.setAttribute('cols', 80);
          input.setAttribute('option', option);
          input.setAttribute('filename', filename);
          input.onchange = computeCommandline;
          return input;
      }

      function decorateText( textOption ) {
          var input = makeCheckBox(textOption.id);
          textOption.appendChild( input );
          textOption.appendChild(makeTextInput(textOption.id));
      }
      function decorateFlag( textOption ) {
          var input = makeCheckBox(textOption.id);
          textOption.appendChild( input );
      }
      function decorateNumber( numberOption ) {
          var input = makeCheckBox(numberOption.id);
          numberOption.appendChild( input );          
          numberOption.appendChild(makeNumberInput(numberOption.id));          
      }
      function decorateTextFile( textFileOption ) {
          var input = makeCheckBox(textFileOption.id);
          textFileOption.appendChild( input );          
          textFileOption.appendChild(makeTextFileInput(textFileOption.id,textFileOption.getAttribute('filename')));          
      }
      function decorateUI() {
          let decor = ( query, decorator) => [...(document.querySelectorAll(query))].forEach( to => decorator( to ) );
          decor('span.textOption', decorateText);
          decor('span.flag', decorateFlag);
          decor('span.numberOption', decorateNumber);
          decor('span.textFile', decorateTextFile);
      }

      function runBL3SaveEdit() {
          disableUI(true);          
          var dashI = document.getElementById('-i');
          var importDotTxt = getTextFileInput(dashI);
          if (importDotTxt && importDotTxt.length > 0) {
              status("Writing Out Imports");
              pkg.write_text('/import.txt', importDotTxt);
          }
          // var newGUID = pkg.randomize_guid();
          var args = commandLineArgs();
          args = ["-f"].concat(args);
          var output = pkg.save_edit_command_line(args);
          logOutput(output);
          characterInfo();
          downloadInputFile("bl3-"+pkg.get_guid()+".sav");
          disableUI(false);          
      }
      function runBL3ProfileEdit() {
          disableUI(true);          
          var dashI = document.getElementById('-i');
          var importDotTxt = getTextFileInput(dashI);
          if (importDotTxt && importDotTxt.length > 0) {
              status("Writing Out Imports");
              pkg.write_text('/import.txt', importDotTxt);
          }
          // var newGUID = pkg.randomize_guid();
          var args = commandLineArgs();
          args = ["-f"].concat(args);
          var output = pkg.profile_edit_command_line(args);
          logOutput(output);
          profileInfo();
          downloadProfileFile("bl3-profile.sav");
          disableUI(false);
      }
      
      async function main(){
          let pyodide = await loadPyodide();
          await pyodide.loadPackage(["micropip"]);
          console.log(pyodide.runPython("\" \".join([\"Hello\",\"World\"])"));
          await pyodide.runPythonAsync(`
    from pyodide.http import pyfetch
    response = await pyfetch("./script.py")
    with open("script.py", "wb") as f:
        f.write(await response.bytes())
`
                                      )          
          status("Loading python");
          pkg = pyodide.pyimport("script");
          status("Installing Python modules");
          await pkg.install_deps();
          status("Python Modules Installed: READY TO GO!");
          disableUI(false);
      }
      disableUI(true);
      window.addEventListener("load", 
                              function() {
                                  decorateUI();
                                  //return;
                                  disableUI(true);
                                  installListeners();
                                  main().then( () => {
                                      disableUI(false);
                                      disableNeedFile(true);
                                  })
                              }, false);
                              
    </script>
  </body>
</html>
